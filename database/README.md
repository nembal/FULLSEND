# QR Batch Database

This directory contains PostgreSQL database schema and utilities for the GTM plastic cups QR code generation system.

## Overview

The `qr_batch` table stores batch-specific QR payloads including:
- `parent_id`: Parent identifier for the QR batch
- `ar_mural_id`: AR mural identifier associated with the batch
- `badge_status`: Status of the badge (active, inactive, pending, expired)
- `qr_payload`: JSONB payload containing QR code data
- `short_url`: Short URL generated via Cloudflare Workers
- Automatic timestamps for tracking creation and updates

## Table Schema

```sql
CREATE TABLE qr_batch (
    batch_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    parent_id VARCHAR(255) NOT NULL,
    ar_mural_id VARCHAR(255) NOT NULL,
    badge_status VARCHAR(50) NOT NULL CHECK (badge_status IN ('active', 'inactive', 'pending', 'expired')),
    qr_payload JSONB NOT NULL,
    short_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL
);
```

## Files

- **`migrations/001_create_qr_batch_table.sql`**: Main migration file to create the table, indexes, and triggers
- **`migrations/002_qr_batch_examples.sql`**: 30+ example SQL queries demonstrating common operations
- **`qr_batch_helper.py`**: Python utility class for programmatic database access

## Setup

### 1. Run the Migration

```bash
# Connect to your PostgreSQL database
psql -U your_user -d your_database -f database/migrations/001_create_qr_batch_table.sql
```

Or using environment variables:

```bash
psql $DATABASE_URL -f database/migrations/001_create_qr_batch_table.sql
```

### 2. Verify Installation

```sql
-- Check table exists
\dt qr_batch

-- Check indexes
\di qr_batch*

-- View table structure
\d qr_batch
```

## Usage

### SQL Examples

See `migrations/002_qr_batch_examples.sql` for comprehensive examples including:

**Insert Operations:**
- Single and bulk inserts
- JSONB payload examples
- Upsert operations

**Query Operations:**
- Lookup by batch_id, parent_id, ar_mural_id
- Real-time short URL lookup
- JSONB field queries
- Status filtering
- Time-based queries

**Update Operations:**
- Status updates
- Short URL updates
- JSONB payload merging
- Bulk updates

**Analytics:**
- Statistics per parent_id
- Status distribution
- Index usage analysis

### Python Usage

```python
from database.qr_batch_helper import QRBatchDB

# Initialize connection
conn_str = "postgresql://user:password@localhost:5432/gtm_db"

with QRBatchDB(conn_str) as db:
    # Create a new batch
    batch = db.create_batch(
        parent_id="parent_001",
        ar_mural_id="ar_mural_123",
        badge_status="active",
        qr_payload={
            "campaign": "summer_2026",
            "product": "plastic_cup",
            "batch_number": 1001
        },
        short_url="https://qr.ly/abc123"
    )
    print(f"Created: {batch['batch_id']}")
    
    # Real-time lookup by short URL
    result = db.get_batch_by_short_url("https://qr.ly/abc123")
    print(f"Found: {result}")
    
    # Update status
    db.update_badge_status(batch['batch_id'], "inactive")
    
    # Get statistics
    stats = db.get_statistics()
    print(f"Stats: {stats}")
```

## Indexes

The table includes optimized indexes for:

1. **Individual field lookups:**
   - `idx_qr_batch_parent_id`: Fast parent_id queries
   - `idx_qr_batch_ar_mural_id`: Fast AR mural lookups
   - `idx_qr_batch_badge_status`: Status filtering
   - `idx_qr_batch_short_url`: Real-time short URL lookup
   - `idx_qr_batch_created_at`: Time-based queries

2. **JSONB queries:**
   - `idx_qr_batch_payload_gin`: Efficient JSONB field searches

3. **Composite queries:**
   - `idx_qr_batch_parent_ar_mural`: Combined parent + AR mural lookups

## Cloudflare Workers Integration

The `short_url` field is designed to store URLs generated by Cloudflare Workers. Typical workflow:

1. **Generate QR batch** → Insert record with `short_url = NULL`
2. **Call Cloudflare Worker** → Generate short URL
3. **Update record** → Set the `short_url` value
4. **Real-time lookup** → Query by `short_url` for instant access

### Example Workflow

```python
# Step 1: Create batch without short URL
batch = db.create_batch(
    parent_id="parent_001",
    ar_mural_id="ar_mural_123",
    badge_status="pending",
    qr_payload={"campaign": "summer_2026"}
)

# Step 2: Generate short URL via Cloudflare Worker
# (Your Cloudflare Worker logic here)
short_url = generate_cloudflare_short_url(batch['batch_id'])

# Step 3: Update the record
db.update_short_url(batch['batch_id'], short_url)

# Step 4: Mark as active
db.update_badge_status(batch['batch_id'], "active")
```

## JSONB Payload Structure

The `qr_payload` field is flexible JSONB. Recommended structure:

```json
{
  "campaign": "summer_2026",
  "product": "plastic_cup",
  "batch_number": 1001,
  "metadata": {
    "location": "warehouse_a",
    "quantity": 1000,
    "manufacturer": "XYZ Corp"
  },
  "tracking": {
    "scans": 0,
    "last_scan": null
  }
}
```

## Badge Status Values

- **`active`**: QR code is currently active and functional
- **`inactive`**: QR code has been temporarily disabled
- **`pending`**: QR code awaiting approval or short URL generation
- **`expired`**: QR code has expired and is no longer valid

## Maintenance

### Finding Batches Needing Short URLs

```sql
SELECT * FROM qr_batch WHERE short_url IS NULL;
```

Or with Python:

```python
pending_batches = db.get_batches_without_short_url()
```

### Expiring Old Batches

```sql
UPDATE qr_batch 
SET badge_status = 'expired'
WHERE created_at < NOW() - INTERVAL '30 days' 
  AND badge_status = 'active';
```

### Cleaning Up Expired Batches

```sql
DELETE FROM qr_batch 
WHERE badge_status = 'expired' 
  AND created_at < NOW() - INTERVAL '90 days';
```

## Dependencies

Python dependencies for `qr_batch_helper.py`:

```bash
pip install psycopg2-binary
```

Or with Poetry:

```bash
poetry add psycopg2-binary
```

## Environment Variables

Recommended environment variables:

```bash
DATABASE_URL=postgresql://user:password@localhost:5432/gtm_db
CLOUDFLARE_WORKER_URL=https://qr.your-domain.com/generate
```

## Performance Considerations

1. **Batch inserts** are more efficient than individual inserts
2. **GIN index** on JSONB enables fast payload queries
3. **Composite indexes** optimize common query patterns
4. **Auto-updated timestamps** use triggers (no application overhead)
5. **UUIDs** provide globally unique identifiers without coordination

## Security Notes

- Use connection pooling in production
- Implement row-level security (RLS) if multi-tenant
- Validate `badge_status` values at application layer
- Sanitize JSONB payloads before insertion
- Use prepared statements to prevent SQL injection

## Testing

Run the example queries:

```bash
psql $DATABASE_URL -f database/migrations/002_qr_batch_examples.sql
```

## Support

For issues or questions about the QR batch system, refer to:
- Project documentation in `/docs`
- System architecture: `SYSTEM_COMPONENTS.md`
- Vision document: `VISION.md`
